<!-- https://stackoverflow.com/questions/6262472/multiple-lines-of-input-in-input-type-text -->
<!DOCTYPE>
<html>

<head>
    <meta charset="UTF-8">
    <title>Badminton v1907241757</title>
    <script src="https://code.jquery.com/jquery-3.4.0.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.1/axios.min.js"></script>
    <script>
        const GAME = {
            /* 玩家
            [
                {
                    name,
                    playCount: 0
                    isPlaying: false,
                    active: true,
					paired: [name,name,..]
                },
            ]
            */
            players: [],

            /* 場地
            [
                {
                    index: 0,
                    players: [],
                },
            ]
            */
            courts: [],

            /**
             *  加場地
             *  @return {Court} - 加入的場地資料
             */
            addCourt() {
                var court = {
                    id: this.courts.length == 0 ? 0 : (this.courts.sort((a, b) => b.id - a.id)[0].id + 1),
                    players: [],
                }
                this.courts.push(court)
                return court
            },

            /**
             *  移除空場地
             *  @return {Court} - 被移除的場地資料
             */
            removeEmptyCourt() {
                var index = this.courts.findIndex(c => c.players.length == 0)
                if (index >= 0) {
                    return this.courts.splice(index, 1)[0];
                }

                return undefined;
            },

            /**
             *  遊戲結束
             *  @param {Number} id - 場地編號
             *  @return {Array} - 那一場的玩家
             */
            gameFinish(id) {
                var court = this.courts.find(c => c.id == id);
                if (court) {
                    var players = court.players.splice(0);
                    players.forEach(p => p.isPlaying = false)
                    return players;
                } else {
                    console.log('court index error', courtIndex);
                    return [];
                }
            },

            /**
             *  下一輪的遊戲
             *  @return {Court[]} - 補上玩家的場地資料array
             */
            nextGame() {
                var emptyCourts = this.courts.filter(c => c.players.length == 0)
				
				if(emptyCourts < 1)
					return

				var freePlayers = this.findPlayersVer2()
				if(freePlayers.length < 4) {
					console.log("!!!組不起來, 清除配對資料, 重新來過!!!")
					this.players.forEach(p => p.paired = [])
					this.nextGame()
				}

				var c = emptyCourts[0]

				freePlayers
					.splice(0, 4)
					.forEach(p => {
						c.players.push(p)
						p.isPlaying = true
						p.playCount++
					})

				// 紀錄組隊資料
				var ps = c.players
				ps[0].paired.push(ps[1].name)
				ps[1].paired.push(ps[0].name)
				ps[2].paired.push(ps[3].name)
				ps[3].paired.push(ps[2].name)
 			
		    		// 推播通知 (只有禮拜三2000~2200 會有效)
		    		axios.post('https://simon-pi.duckdns.org:9876/notify', {
                        		names: c.players.map(p => p.name),
                    		}).catch(e => console.error(e))
		    
				console.log('court', c.id, ', players', c.players)

                return [c].concat(emptyCourts.length > 1 ? this.nextGame() : [])
            },
			
			findTeammate(starter, players, blockedPlayers) {
				return this.findNonBlockedPlayers(players, blockedPlayers).filter(p => !starter.paired.includes(p.name))
			},
			
			findNonBlockedPlayers(players, blockedPlayers) {
				return players.filter(p => !blockedPlayers.includes(p))
			},
			
			findEnemiesByTeammate(teammate, players, selectedPlayers) {
				var tempSelected = selectedPlayers.slice()
				tempSelected.push(teammate) // 暫時把這名隊友加入已被選擇的隊列中
				
				var enemies = this.findNonBlockedPlayers(players, tempSelected) // 篩選出可能作為敵人的人

				if(enemies.length < 2) { // 敵人人選不足直接跳過
					return []
				}
				
				for(var k in enemies) {
					var enemy = enemies[k]
					var tempBlockForEnemy = tempSelected.slice()
					tempBlockForEnemy.push(enemy)
					
					var enemyTeammates = this.findTeammate(enemy, players, tempBlockForEnemy)
					if(enemyTeammates.length < 1) {
						continue
					} else {
						return [enemy, enemyTeammates[0]] // [敵人, 敵人的隊友]
					}
				}
			},
			
			findMatchPlayersByStarter(starter, players) {
				var blocked = [starter]
				
				var teammates = this.findTeammate(starter, players, blocked) // 先找出可能成為隊友的清單
				if(teammates.length < 1) { // 沒有可用的隊友, 直接放棄
					return []
				}
				
				for(var k in teammates) { // 依序嘗試配對每個清單中的人
					var teammate = teammates[k]
					
					var enemies = this.findEnemiesByTeammate(teammate, players, blocked)
					if(enemies.length < 2) // 數量小於2表示沒有找到適合人選
						continue

					return [starter, teammate, enemies[0], enemies[1]] // [起始者, 起始者隊友, 對手A, 對手B]
				}
				
				// 都沒有適合的組合, 回傳空陣列
				return []
			},
			
			findPlayersVer2() {
				var idlePlayers = this.players.filter(p => !p.isPlaying)                      // 挑出放空的人, 同時複製一份新陣列
				
				if(idlePlayers.length < 4){ // 人數不足
					return []
				}
				
				var sortedIdlePlayers = idlePlayers
											.sort((a,b) => {
												if(a.playCount !== b.playCount){ // 次數最少的人最優先
													return a.playCount - b.playCount
												} else if (a.paired.length !== b.paired.length) {
													return a.paired.length - b.paired.length // 第二篩選曾經配過人數最低者優先
												} else {
													return Math.random() - 0.5 // 隨機排序
												}
											});

				for(var k in sortedIdlePlayers) {
					var starter = sortedIdlePlayers[k]
					var finalPlayers = this.findMatchPlayersByStarter(starter, sortedIdlePlayers)

					if(finalPlayers.length === 4)
						return finalPlayers
				}
				
				return []
			},

            _mockingData() {
                this.players = 'ABCDEFG'.split('')
                    .map(name => ({
                        name,
                        playCount: Math.floor(Math.random() * 3),
                        isPlaying: false,
                        active: true,
						paired: []
                    }));

                this.addCourt();
                this.addCourt();
            },
        };
        //GAME._mockingData()
        console.log(GAME);

        function getPlayersFromUI() {
            GAME.players.length = 0;

            $('table.players tbody tr').each(function () {
                var $tr = $(this);
                var active = $tr.find('.active').prop('checked');
                var name = $tr.find('.name').val().trim();

                if (active && name.length > 0) {
                    var isPlaying = $tr.find('.court').val().length > 0;

                    // playCount 會當array index, 不允許負值
                    var playCount = parseInt($tr.find('.playCount').val().trim(), 10) || 0;
                    playCount = Math.max(playCount, 0);
					var paired = $tr.find('.paired').val().trim().split(',')

                    GAME.players.push({
                        name,
                        isPlaying,
                        playCount,
						paired
                    })
                }
            });

            console.log('getPlayersFromUI', GAME.players)
        }

        function fillDefaultPlayers() {
            var $tr = $('table.players tbody tr');

            [
                { name: 'Jack', active: true },
                { name: '逸涵', active: true },
                { name: 'Simon', active: true },
                { name: 'Fred', active: true },
                { name: 'Eric', active: true },
                { name: '書汶', active: true },
                { name: 'Dennis', active: true },
                { name: 'Tony', active: true },
                { name: 'Bryan', active: true },
                { name: 'Amy', active: true },
                { name: 'Evan', active: true },
                { name: 'Landice', active: true },
                { name: 'Hogan', active: true },
                { name: 'Jerry', active: true },
                { name: 'Carrie', active: true },
                { name: 'Trista (姿妤)', active: true },

                { name: 'Flora (曉楓)', active: false },
                { name: 'FS', active: false },
                { name: 'Rex', active: false },
                { name: 'Hester', active: false },
                { name: 'Smart', active: false },
                { name: '黑黑', active: false },
            ].forEach(p => {
                var clone = $tr.clone()
                    .find('.active').prop('checked', p.active).end()
                    .find('.playCount').val(0).end()
                    .find('.name').val(p.name).end()

                $tr.before(clone);
            })
        }

        function findRowByPlayerName(name) {
            var tr = $('table.players tbody input:text.name').filter(function () {
                return this.value.trim() == name;
            }).closest('tr');

            return tr;
        }

        $(document).ready(function () {
            // 從預設值填到玩家UI
            fillDefaultPlayers();

            // 場地編輯
            $('input.courtEdit').click(function () {
                var add = parseInt(this.dataset.num, 10) > 0;
                if (add) {
                    var court = GAME.addCourt();

                    var $div = $('div.court:first')
                    var $clone = $div.clone()
                        .attr('id', court.id)
                        .find('.player').each(function () { $(this).text(''); }).end()
                        .find('.finish').hide().end()
                        .show();

                    $div.parent().append($clone);
                } else {
                    var court = GAME.removeEmptyCourt();

                    if (court) {
                        $('div.court')
                            .filter(function () {
                                return $(this).attr('id') == court.id;
                            })
                            .remove();
                    }
                }
            });

            // 一開始幫他按兩場
            $('input.courtEdit[data-num="1"]')
                .trigger('click')
                .trigger('click');

            // 下一場遊戲 按鈕
            $('#nextGame').click(function () {
                getPlayersFromUI();

                // 結束按鈕都關閉
                $('div.courts .finish').hide();

                GAME.nextGame()
                    .forEach(court => {
                        // 整理場地UI
                        $('div.court')
                            .filter(function () {
                                return $(this).attr('id') == court.id;
                            })
                            .find('.player')
                            .each(function (i) {
                                $(this).text(court.players[i].name)
                            })

                        // 整理玩家UI
                        court.players.forEach(player => {
                            findRowByPlayerName(player.name)
                                .find('input').prop('disabled', true).end()         // 不能編輯那個玩家
                                .find('.isPlaying').prop('checked', true).end()     // 正在玩
                                .find('.court').val(court.id).end()                 // 哪個場地
                                .find('.playCount').val(player.playCount).end()     // 玩幾場了
                                .find('.paired').val(player.paired.join()).end()    // 紀錄已配對資料
                        })
                    })

            })

            // 編輯最後一行幫他加新row
            $('table').on('change', 'input.name', function () {
                var $tr = $(this).closest('tr');
                var isEmpty = this.value.trim().length == 0;
                var isLast = $tr.is(':last-child');

                if (!isEmpty && isLast) {
                    var clone = $tr.clone()
                        .find('.playCount').val(0).end()
                        .find('.name').val('').end()

                    $tr.after(clone);
                }
            });

            // 計算總人數
            $('table').on('change', 'input.active, input.name', function () {
                var validRows = $('table.players tbody tr').filter(function () {
                    var $tr = $(this);
                    var active = $tr.find('.active').prop('checked');
                    var name = $tr.find('.name').val().trim();

                    return active && name.length > 0
                });

                $('input.total').val(validRows.length)
            });

            // trigger 計算總人數
            $('input.active:first').trigger('change');

            // 場地 顯示[結束按鈕]
            $('div.courts').on('click', 'div.court', function () {
                $(this).find('.finish').toggle();
            })

            // 場地 [結束按鈕]
            $('div.courts').on('click', '.finish', function (event) {
                // prevent div.court trigger click event
                event.stopPropagation();

                var $court = $(this).closest('div.court');
                var courtId = $court.attr('id');
                console.log('finish', courtId);

                // 整理場地UI
                $court
                    .find('.finish').hide().end()
                    .find('.player').each(function () {
                        $(this).text('')
                    })

                // 整理玩家UI
                GAME.gameFinish(courtId)
                    .forEach(player => {
                        // 整理玩家UI
                        findRowByPlayerName(player.name)
                            .find('input.editable').prop('disabled', false).end()   // 可以編輯
                            .find('.isPlaying').prop('checked', false).end()        // 正在玩
                            .find('.court').val('').end()                           // 場地
                    })
            })
			
			// 球員快速導入功能
			$('#importPlayerButton').click(function () {
				var data = document.querySelector("#playerNameData").value
				console.log("get player data : " + data)
				var startPos = data.indexOf('):')
				if(startPos < 0){
					alert('格式不符!!')
				} else {
					var players = data.substring(startPos+2)
										.split('\n')
										.filter(n => n !== "" && n.indexOf(':') === -1)
					console.log(players)
					
					var playerRows = document.querySelectorAll('table.players tbody tr')
					for(var i=0; i< playerRows.length; i++){
						var hasMappingName = i < players.length
						var name = hasMappingName ? players[i] : i.toString()
						//console.log("index:" + i +"'s name is " + name)
						playerRows[i].querySelector(".active").checked = hasMappingName
						playerRows[i].querySelector(".name").value = name
					}
					
					$('input.active:first').trigger('change')
				}
			})
        });
    </script>
</head>

<body>
    <div class="players float">
        <p>
            Total: <input type="text" class="total" disabled>
        </p>
		<p>
			import players:  <textarea id="playerNameData" cols="20" rows="5"></textarea> <input type="button" value="import!" id="importPlayerButton">
		</p>
        <table class="players">
            <thead>
                <th>加</th>
                <th>誰</th>
                <th>場</th>
                <th>量</th>
				<th>配</th>
            </thead>
            <tbody>
                <tr>
                    <td><input type="checkbox" class="active editable"></td>
                    <td><input type="text" class="name editable"></td>
                    <td><input type="text" class="court" disabled></td>
                    <td><input type="text" class="playCount editable" value="0"></td>
                    <td><input type="text" class="paired" value=""></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="courts float">
        <div class="courtControl">
			<label for="add court">場</label>
            <input id="add court" type="button" value="+" class="courtEdit" data-num="1">
            <input type="button" value="-" class="courtEdit" data-num="-1">
        </div>

        <input type="button" value="配" id="nextGame">

        <div class="court" style="display:none;">
            <input type="button" value="終" class="finish">
            <div class="team">
                <span class="player"></span>
                <span class="player"></span>
            </div>
            <div class="team">
                <span class="player"></span>
                <span class="player"></span>
            </div>
        </div>

    </div>
</body>
<style>
    body {
        overscroll-behavior: contain;
    }

    input[type=text] {
        width: 30px;
    }

    input.name {
        width: 100px;
		color: #1B1D1B;
    }

    input:not(.name) {
        text-align: center;
		color: #1B1D1B;
    }
    
    input.paired {
        width: 200px;
    }

    div {
        padding: 10px;
    }

    div.float {
        float: left;
    }

    div.courts {
        background: #2E8748;
        text-align: center;
    }

    div.court {
        <!-- border: solid 2px white; -->
        background-color: #2E8748;
        margin: 10px;
    }

    div.team {
		border: solid 2px #EBFFF0;
        background-color: #2E8748;
		color: #1B1D1B;
        min-height: 20px;
        min-width: 150px;
    }
</style>

</html>
